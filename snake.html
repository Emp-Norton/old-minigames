<html>
<head>
  <title> Disco Snake </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">  
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>
  <div class="main-content">
    <div class="row">
      <div>
        <canvas id='field' height='400' width='400' style="margin: 1em auto; display:block;"></canvas>
      </div>
    </div>
  </div>
  <script>
    const updateScore = (newScore) => {
      const scoreArea = $('#score');
      const highscoreArea = $('#highscore');
      scoreArea.html(`Score: ${newScore}`);
      bestScore > highscore
        ? highscoreArea.html(`Highest Score is now: ${bestScore}!`)
        : highscoreArea.html(`Highest Score: ${bestScore}.`)
    };

    const getColor = () => {
      const rgbVals = [];
      for (let i = 0; i < 3; i++) {
        rgbVals.push(Math.floor(Math.random() * Math.floor(256)));
      }
      return `rgba(${rgbVals[0]},${rgbVals[1]},${rgbVals[2]})`
    }
    
    const keyPush = (e) => {
      getColor()
      switch(e.keyCode) {
        case 37:
          horizSpeed = -1;
          vertSpeed = 0;
          break;
        case 38:
          horizSpeed = 0;
          vertSpeed = -1;
          break;
        case 39:
          horizSpeed = 1;
          vertSpeed = 0;
          break;
        case 40:
          horizSpeed = 0;
          vertSpeed = 1;
          break;
      }
    }

    let score = 0; // persist high score in local memory?
    let bestScore = 0;
    const canvas = document.getElementById("field");
    const ctx = canvas.getContext("2d");
    
    $(document).ready(function() {
      document.addEventListener("keydown", keyPush);
      setInterval(game, 200);
      if (!!localStorage.getItem('highscore')) {
        bestScore = localStorage.getItem('highscore');
      }
    });
    
    const snakeGreen = '#00FF00';
    const appleRed = '#FF0000';
    const poisonYellow = '#FFFF33'; // #FFFF00
    const backgroundBlack = '#000'

    let snakeCoordX = snakeCoordY = 10;
    let gridSize = tileCount = 20;
    let appleX = appleY = 15;
    let poison1X, poison1Y, poison2X, poison2Y, poison3X, poison3Y;
    let horizSpeed = vertSpeed = 0;
    const trail = [];
    let tail = 5;


    const game = () => {
      snakeCoordX += horizSpeed;
      snakeCoordY += vertSpeed;
      if (snakeCoordX < 0) snakeCoordX = tileCount - 1;
      if (snakeCoordX > tileCount - 1) snakeCoordX = 0;
      if (snakeCoordY < 0) snakeCoordY = tileCount - 1;
      if (snakeCoordY > tileCount - 1) snakeCoordY = 0;
    
      ctx.fillStyle = backgroundBlack; 
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = snakeGreen; 
      
      for (let i = 0; i < trail.length; i++) {
        
        if (trail.length > 7) {  
          let colorString = getColor();
          ctx.fillStyle = colorString;
        }

        ctx.fillRect(trail[i].x * gridSize, trail[i].y * gridSize, gridSize - 2, gridSize - 2)
        if (trail[i].x == snakeCoordX && trail[i].y == snakeCoordY) {
          // need death notification or restart
          // reset to green for now
          ctx.fillStyle = snakeGreen;
          // check against highscore in memory
          score = 0;
          updateScore(score);
          tail = 5;
        }
      }

      trail.push({x: snakeCoordX, y: snakeCoordY});
      while (trail.length > tail) {
        trail.shift();
      }

      if (appleX == snakeCoordX && appleY == snakeCoordY) {
        tail++;
        score++;
        if (score > bestScore){
          bestScore = score;
          localStorage.setItem('highscore', bestScore);
        }
        updateScore(score);
        appleX = Math.floor((Math.random() * tileCount));
        appleY = Math.floor((Math.random() * tileCount));
        poison1X = Math.floor((Math.random() * tileCount));
        poison2X = Math.floor((Math.random() * tileCount));
        poison3X = Math.floor((Math.random() * tileCount));
        poison1Y = Math.floor((Math.random() * tileCount));
        poison2Y = Math.floor((Math.random() * tileCount));
        poison3Y = Math.floor((Math.random() * tileCount));
      }

      ctx.fillStyle = appleRed; 
      ctx.fillRect(appleX * gridSize, appleY * gridSize, gridSize - 2, gridSize - 2);

      ctx.fillStyle = poisonYellow;  
      ctx.fillRect(poison1X * gridSize, poison1Y * gridSize, gridSize - 2, gridSize - 2);
      ctx.fillRect(poison2X * gridSize, poison2Y * gridSize, gridSize - 2, gridSize - 2);
      ctx.fillRect(poison3X * gridSize, poison3Y * gridSize, gridSize - 2, gridSize - 2);

    }

  </script>

  <div id="display-field">
    <!-- need some styles here -->
    <h1 id="score"> Score: </h1>
    <h2 id="highscore"> Highest Score: </h2>
  </div>
</body>
</html>
